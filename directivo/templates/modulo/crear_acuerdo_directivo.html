{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matriz de Acuerdos</title>
    <!-- Vincular CSS -->
    <link rel="stylesheet" href="{% static 'css/modulo.css' %}">
</head>
<body>

<form method="post">
  {% csrf_token %}
  <table id="tabla-acuerdos">
    <thead>
      <tr>
        <th>#</th>
        <th>Unidad</th>
        <th>Acuerdo</th>
        <th>Unidad Parada</th>
        <th>Fecha Límite</th>
        <th>Pendiente</th>
        <th>Responsable</th>
        <th>% Avance</th>
        <th>Agregar</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="number" name="numerador" value="1" min="1" required></td>
        <td>
          <select name="unidad" required>
            {% for i in unidades %}
              <option value="{{ i }}">{{ i }}</option>
            {% endfor %}
          </select>
        </td>
        <td><input type="text" name="acuerdo" required></td>
        <td><input type="checkbox" name="unidad_parada"></td>
        <td><input type="date" name="fecha_limite" value="{{ fecha_actual|date:'Y-m-d' }}" required></td>
        <td><input type="checkbox" name="pendiente" checked></td>
        <td>
          <select name="responsable" required>
            {% for integrante in integrantes %}
              <option value="{{ integrante.id }}">{{ integrante.nombre_completo }} - {{ integrante.puesto }}</option>
            {% endfor %}
          </select>
        </td>
        <td><input type="number" name="porcentaje_avance" min="0" max="100" value="0" required></td>
        <td><button type="button" class="agregar-fila">+</button></td>
        <td><button type="button" class="eliminar-fila">-</button></td>
      </tr>
    </tbody>
  </table>
  <button type="submit">Guardar Matriz</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const tabla = document.getElementById("tabla-acuerdos").getElementsByTagName('tbody')[0];
  const form = document.querySelector("form");

  tabla.addEventListener("click", function(e) {
    if (e.target.classList.contains("agregar-fila")) {
      const fila = e.target.closest("tr").cloneNode(true);
      fila.querySelectorAll("input").forEach(input => {
        if(input.type === "text" || input.type === "number") input.value = '';
        if(input.type === "checkbox") input.checked = false;
      });
      tabla.appendChild(fila);
    }

    if (e.target.classList.contains("eliminar-fila")) {
      if(tabla.rows.length > 1){
        e.target.closest("tr").remove();
      } else {
        alert("No se puede eliminar la última fila.");
      }
    }
  });

  form.addEventListener("submit", function(e) {
    let error = false;
    tabla.querySelectorAll("tr").forEach((fila, index) => {
      const numerador = fila.querySelector("input[name='numerador']").value;
      const acuerdo = fila.querySelector("input[name='acuerdo']").value;
      const fecha = fila.querySelector("input[name='fecha_limite']").value;
      const avance = fila.querySelector("input[name='porcentaje_avance']").value;
      const responsable = fila.querySelector("select[name='responsable']").value;

      if (!numerador || !acuerdo || !fecha || !avance || !responsable) {
        alert(`Fila ${index + 1} tiene campos incompletos.`);
        error = true;
      }
      if (avance < 0 || avance > 100) {
        alert(`Fila ${index + 1}: % de avance debe estar entre 0 y 100.`);
        error = true;
      }
    });

    if (error) e.preventDefault();
  });
});
</script>

</body>
</html>
